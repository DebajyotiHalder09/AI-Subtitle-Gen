<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subgen</title>
    <link rel="stylesheet" href="\static\css\mstyles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <h1 class="display-1 text-center mb-2">AI Subtitle Generator</h1>
    <h6 class="display-7 text-center">Powered by Openai-Whisper | Model: tiny.en</h6>

    <div class="container">
        <div class="row my-4">
            <div class="col-4">
                <button class="btn btn-success btn-lg w-100" onclick="document.getElementById('audioInput').click()">
                    <i class="fas fa-music"></i> Choose Audio
                </button>
                <input type="file" id="audioInput" accept="audio/*" style="display: none;" onchange="updateAudioFileName()">
            </div>
            <div class="col-4">
                <button class="btn btn-success btn-lg w-100" onclick="document.getElementById('jsonInput').click()">
                    <i class="fas fa-file-code"></i> Choose JSON
                </button>
                <input type="file" id="jsonInput" accept=".json" style="display: none;" onchange="updateJSONFileName()">
            </div>
            <div class="col-4 text-center">
                <button id="transcribeBtn" class="btn btn-success btn-lg w-100" onclick="transcribeAudio()">
                    <i class="fas fa-cogs"></i> Transcribe
                </button>
                <button id="generateBtn" class="btn btn-success btn-lg w-100 mt-2" onclick="generateJSON()" disabled>
                    <i class="fas fa-file-download"></i> Download
                </button>
                <div id="loader" class="spinner-border text-success my-3" style="display: none;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            
        </div>

        <!-- Rows to display selected file names -->
        <div class="row">
            <div class="col-12">
            <h4 id="audioFileName" class="text-center text-muted p-2" style="border: 1px solid #ccc; background-color: #f0f8ff;">No audio file chosen</h4>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
            <h4 id="jsonFileName" class="text-center text-muted p-2" style="border: 1px solid #ccc; background-color: #f0f8ff;">No JSON file chosen</h4>
            </div>
        </div>

        <!-- Subtitle Display -->
        <div id="subtitleBox">Subtitles will appear here...</div>

        <!-- Audio Controls -->
        <div class="audio-controls">
            <button id="playPauseBtn" class="btn btn-primary" onclick="togglePlayPause()">Play</button>
            <input id="progressBar" class="progress-bar" type="range" min="0" max="100" value="0" step="1" onchange="seekAudio()"style="width: 40%;">
            <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
            <input id="volumeControl" type="range" min="0" max="1" step="0.1" value="1" onchange="adjustVolume()" class="mx-2">
            <select id="playbackSpeed" onchange="adjustPlaybackSpeed()" class="mx-2">
                <option value="0.75">0.75x</option>
                <option value="0.8">0.8x</option>
                <option value="0.9">0.9x</option>
                <option value="0.94">0.94x</option>
                <option value="0.95">0.95x</option>
                <option value="0.96">0.96x</option>
                <option value="0.98">0.98x</option>
                <option value="1" selected>1x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
            </select>
        </div>
        <audio id="audioPlayer" ontimeupdate="syncSubtitles()"></audio>
    </div>

    <script src="https://kit.fontawesome.com/99363101d6.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Global variables
        let serverUrl = localStorage.getItem('serverUrl') || 'https://aiensubgen.onrender.com';
        let subtitles = [];
        let audioLoaded = false;
    
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial server URL
            document.getElementById('serverUrl').value = serverUrl;
            
            // Add audio player event listeners
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.addEventListener('timeupdate', updateProgressBar);
            audioPlayer.addEventListener('loadedmetadata', updateProgressBar);
            audioPlayer.addEventListener('timeupdate', syncSubtitles);
    
            // Initialize volume
            document.getElementById('volumeControl').value = 1;
        });
    
        // Server URL management
        function saveServerUrl() {
            const input = document.getElementById('serverUrl');
            serverUrl = input.value.trim() || 'https://aiensubgen.onrender.com';
            localStorage.setItem('serverUrl', serverUrl);
            alert('Server URL saved: ' + serverUrl);
        }
    
        // File management functions
        function updateAudioFileName() {
            const audioInput = document.getElementById('audioInput');
            const audioFileName = document.getElementById('audioFileName');
            audioFileName.textContent = audioInput.files.length > 0 
                ? `Audio: ${audioInput.files[0].name}` 
                : 'No audio file selected';
            
            // Reset audio player when new file is selected
            audioLoaded = false;
            document.getElementById('playPauseBtn').textContent = 'Play';
        }
    
        function updateJSONFileName() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonFileName = document.getElementById('jsonFileName');
            jsonFileName.textContent = jsonInput.files.length > 0 
                ? `Subtitles: ${jsonInput.files[0].name}` 
                : 'No subtitle file selected';
            
            if (jsonInput.files.length > 0) {
                loadSubtitles();
            }
        }
    
        // Transcription function
        async function transcribeAudio() {
            const audioInput = document.getElementById('audioInput');
            const loader = document.getElementById('loader');
            const generateBtn = document.getElementById('generateBtn');
            const subtitleBox = document.getElementById('subtitleBox');
    
            if (!audioInput.files.length) {
                alert("Please select an audio file first!");
                return;
            }
    
            loader.style.display = 'block';
            generateBtn.disabled = true;
            subtitleBox.textContent = 'Transcribing...';
    
            const formData = new FormData();
            formData.append('audio', audioInput.files[0]);
    
            try {
                const response = await fetch(`${serverUrl}/transcribe`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                });
    
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
    
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
    
                subtitles = data.subtitles;
                generateBtn.disabled = false;
                subtitleBox.textContent = 'Transcription complete! Click Download Subtitles to save.';
                alert("Transcription complete! You can now download the subtitles.");
    
            } catch (error) {
                console.error('Transcription error:', error);
                alert("Error during transcription: " + error.message);
                subtitleBox.textContent = 'Transcription failed. Please try again.';
            } finally {
                loader.style.display = 'none';
            }
        }
    
        // Generate and download JSON
        async function generateJSON() {
            const loader = document.getElementById('loader');
            const generateBtn = document.getElementById('generateBtn');
            
            if (!subtitles || subtitles.length === 0) {
                alert('No subtitles available. Please transcribe first.');
                return;
            }
    
            loader.style.display = 'block';
            generateBtn.disabled = true;
    
            try {
                const response = await fetch(`${serverUrl}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ subtitles: subtitles }),
                    mode: 'cors',
                });
    
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
    
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'subtitles.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
    
            } catch (error) {
                console.error('Generation error:', error);
                alert("Error generating subtitles: " + error.message);
            } finally {
                loader.style.display = 'none';
                generateBtn.disabled = false;
            }
        }
    
        // Subtitle loading and syncing
        function loadSubtitles() {
            const jsonInput = document.getElementById('jsonInput');
            const subtitleBox = document.getElementById('subtitleBox');
    
            if (!jsonInput.files.length) {
                alert('Please select a JSON file');
                return;
            }
    
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const parsedSubtitles = JSON.parse(event.target.result);
                    if (!Array.isArray(parsedSubtitles)) {
                        throw new Error('Invalid subtitle format');
                    }
    
                    subtitles = parsedSubtitles.filter(sub => 
                        sub.start !== undefined && 
                        sub.end !== undefined && 
                        sub.text !== undefined
                    );
    
                    if (subtitles.length === 0) {
                        throw new Error('No valid subtitles found');
                    }
    
                    subtitleBox.textContent = 'Subtitles loaded successfully';
                    document.getElementById('generateBtn').disabled = false;
    
                } catch (error) {
                    console.error('Subtitle loading error:', error);
                    subtitleBox.textContent = 'Error loading subtitles';
                    alert(error.message);
                }
            };
    
            reader.readAsText(jsonInput.files[0]);
        }
    
        // Audio player controls
        function togglePlayPause() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            const audioPlayer = document.getElementById('audioPlayer');
            const audioInput = document.getElementById('audioInput');
    
            if (!audioInput.files.length) {
                alert("Please select an audio file first!");
                return;
            }
    
            if (!audioLoaded) {
                audioPlayer.src = URL.createObjectURL(audioInput.files[0]);
                audioLoaded = true;
            }
    
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseBtn.textContent = 'Pause';
            } else {
                audioPlayer.pause();
                playPauseBtn.textContent = 'Play';
            }
        }
    
        function updateProgressBar() {
            const audioPlayer = document.getElementById('audioPlayer');
            const progressBar = document.getElementById('progressBar');
            const currentTime = document.getElementById('currentTime');
            const duration = document.getElementById('duration');
    
            if (!isNaN(audioPlayer.duration)) {
                const value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.value = value;
                currentTime.textContent = formatTime(audioPlayer.currentTime);
                duration.textContent = formatTime(audioPlayer.duration);
            }
        }
    
        function seekAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            const progressBar = document.getElementById('progressBar');
            const seekTime = (progressBar.value / 100) * audioPlayer.duration;
            audioPlayer.currentTime = seekTime;
        }
    
        function syncSubtitles() {
            const audioPlayer = document.getElementById('audioPlayer');
            const subtitleBox = document.getElementById('subtitleBox');
            const currentTime = audioPlayer.currentTime;
    
            if (!subtitles || subtitles.length === 0) {
                return;
            }
    
            const currentSubtitle = subtitles.find(sub => 
                currentTime >= sub.start && 
                currentTime <= sub.end
            );
    
            subtitleBox.textContent = currentSubtitle ? currentSubtitle.text : '';
        }
    
        function adjustVolume() {
            const volumeControl = document.getElementById('volumeControl');
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.volume = volumeControl.value;
        }
    
        function adjustPlaybackSpeed() {
            const playbackSpeed = document.getElementById('playbackSpeed');
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.playbackRate = parseFloat(playbackSpeed.value);
        }
    
        // Utility function
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
    </script>
    <!-- <footer class="fixed-bottom bg-dark text-light text-center py-2">
        <p class="mb-0">&copy; 2025 AI Subtitle Generator. All rights reserved.</p><br>
        <p>Creator: Debajyoti Halder Ayon</p>
    </footer> -->
</body>
</html>
